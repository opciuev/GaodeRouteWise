<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€åŒ–ç‰ˆæ—…æ¸¸è·¯çº¿è§„åˆ’åŠ©æ‰‹</title>
    <script>
        window._AMapSecurityConfig = {
            securityJsCode: "db2b6cf5ae4f82ee233b1abe16aa459a",
        }
    </script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .header { text-align: center; margin-bottom: 30px; }
        .api-setup { background: #e7f3ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .main-content { display: grid; grid-template-columns: 300px 1fr 350px; gap: 20px; }
        .panel { background: #f8f9fa; padding: 20px; border-radius: 8px; }
        input, select, button { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; cursor: pointer; }
        button:hover { background: #0056b3; }
        #map { width: 100%; height: 500px; border: 1px solid #ddd; }
        .location-btn { background: #28a745; font-size: 12px; padding: 5px 10px; }
        .result-item { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ºï¸ æ—…æ¸¸è·¯çº¿è§„åˆ’åŠ©æ‰‹</h1>
            <p>æ™ºèƒ½è§„åˆ’ä½ çš„å‡ºè¡Œè·¯çº¿</p>
        </div>

        <!-- APIè®¾ç½® -->
        <div id="api-setup" class="api-setup">
            <h3>ğŸ”‘ è®¾ç½®APIå¯†é’¥</h3>
            <input type="password" id="api-key" placeholder="è¾“å…¥é«˜å¾·åœ°å›¾APIå¯†é’¥" style="width: 300px;">
            <button onclick="loadAPI()">åŠ è½½åœ°å›¾</button>
            <button onclick="clearCache()" style="background: #dc3545;">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</button>
            <div id="api-status">è¯·è¾“å…¥APIå¯†é’¥</div>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div id="main-content" class="main-content" style="display: none;">
            <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="panel">
                <h3>ğŸ“ è·¯çº¿è®¾ç½®</h3>
                
                <div style="margin-bottom: 15px;">
                    <label>å‡ºå‘åœ°ï¼š</label><br>
                    <input type="text" id="origin" placeholder="è¾“å…¥å‡ºå‘åœ°å€" style="width: 100%;">
                    <button class="location-btn" onclick="getCurrentLocation()">ğŸ“ å½“å‰ä½ç½®</button>
                    <button class="location-btn" onclick="getIPLocation()">ğŸŒ IPå®šä½</button>
                </div>

                <div style="margin-bottom: 15px;">
                    <label>ç›®çš„åœ°ï¼š</label><br>
                    <input type="text" id="destination" placeholder="è¾“å…¥ç›®çš„åœ°å€" style="width: 100%;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label>äº¤é€šæ–¹å¼ï¼š</label><br>
                    <select id="transport-mode" style="width: 100%;">
                        <option value="all">å…¨éƒ¨æ–¹æ¡ˆ</option>
                        <option value="driving">ğŸš— é©¾è½¦</option>
                        <option value="walking">ğŸš¶ æ­¥è¡Œ</option>
                        <option value="transit">ğŸšŒ å…¬äº¤</option>
                        <option value="riding">ğŸš´ éª‘è¡Œ</option>
                    </select>
                </div>

                <button onclick="planRoute()" style="width: 100%; padding: 15px; font-size: 16px;">ğŸ—ºï¸ å¼€å§‹è§„åˆ’è·¯çº¿</button>

                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                    <h4>ğŸ”§ å·¥å…·</h4>
                    <button onclick="clearCache()" style="width: 100%; background: #dc3545;">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</button>
                    <button onclick="reloadPage()" style="width: 100%; background: #28a745; margin-top: 5px;">ğŸ”„ é‡æ–°åŠ è½½</button>
                </div>
            </div>

            <!-- ä¸­é—´åœ°å›¾ -->
            <div class="panel">
                <div id="map"></div>
            </div>

            <!-- å³ä¾§ç»“æœ -->
            <div class="panel">
                <h3>ğŸ“Š è·¯çº¿æ–¹æ¡ˆ</h3>
                <div id="results">
                    <p style="text-align: center; color: #666; padding: 40px;">
                        è®¾ç½®å‡ºå‘åœ°å’Œç›®çš„åœ°ï¼Œå¼€å§‹è§„åˆ’è·¯çº¿
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let AMap;

        function loadAPI() {
            const key = document.getElementById('api-key').value.trim();
            const status = document.getElementById('api-status');
            
            if (!key) {
                status.innerHTML = 'âŒ è¯·è¾“å…¥APIå¯†é’¥';
                return;
            }

            status.innerHTML = 'ğŸ”„ æ­£åœ¨åŠ è½½...';

            // ç§»é™¤æ—§è„šæœ¬
            const oldScript = document.querySelector('script[src*="webapi.amap.com"]');
            if (oldScript) oldScript.remove();
            if (window.AMap) delete window.AMap;

            const script = document.createElement('script');
            script.src = `https://webapi.amap.com/maps?v=1.4.15&key=${key}`;
            
            script.onload = () => {
                if (window.AMap) {
                    AMap = window.AMap;
                    initMap();
                    document.getElementById('api-setup').style.display = 'none';
                    document.getElementById('main-content').style.display = 'grid';
                    status.innerHTML = 'âœ… åœ°å›¾åŠ è½½æˆåŠŸ';
                } else {
                    status.innerHTML = 'âŒ APIå¯¹è±¡æœªæ‰¾åˆ°';
                }
            };
            
            script.onerror = () => {
                status.innerHTML = 'âŒ APIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†é’¥';
            };
            
            document.head.appendChild(script);
        }

        function initMap() {
            try {
                map = new AMap.Map('map', {
                    zoom: 11,
                    center: [116.397428, 39.90923]
                });
                console.log('âœ… åœ°å›¾åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                console.error('âŒ åœ°å›¾åˆ›å»ºå¤±è´¥:', error);
                document.getElementById('api-status').innerHTML = 'âŒ åœ°å›¾åˆ›å»ºå¤±è´¥: ' + error.message;
            }
        }

        function getCurrentLocation() {
            if (!AMap) {
                alert('è¯·å…ˆåŠ è½½åœ°å›¾');
                return;
            }

            AMap.plugin('AMap.Geolocation', function() {
                const geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,
                    timeout: 10000
                });

                geolocation.getCurrentPosition(function(status, result) {
                    if (status === 'complete') {
                        const address = result.formattedAddress || `${result.position.lng}, ${result.position.lat}`;
                        document.getElementById('origin').value = address;
                        
                        if (map && result.position) {
                            map.setCenter([result.position.lng, result.position.lat]);
                            map.setZoom(15);
                        }
                        alert('âœ… å®šä½æˆåŠŸ');
                    } else {
                        alert('âŒ å®šä½å¤±è´¥');
                    }
                });
            });
        }

        function getIPLocation() {
            if (!AMap) {
                alert('è¯·å…ˆåŠ è½½åœ°å›¾');
                return;
            }

            AMap.plugin('AMap.CitySearch', function() {
                const citySearch = new AMap.CitySearch();
                citySearch.getLocalCity(function(status, result) {
                    if (status === 'complete' && result.info === 'OK') {
                        document.getElementById('origin').value = result.city;
                        alert('âœ… IPå®šä½æˆåŠŸ: ' + result.city);
                    } else {
                        alert('âŒ IPå®šä½å¤±è´¥');
                    }
                });
            });
        }

        function planRoute() {
            const origin = document.getElementById('origin').value.trim();
            const destination = document.getElementById('destination').value.trim();
            const mode = document.getElementById('transport-mode').value;

            if (!origin || !destination) {
                alert('è¯·è¾“å…¥å‡ºå‘åœ°å’Œç›®çš„åœ°');
                return;
            }

            if (!AMap) {
                alert('è¯·å…ˆåŠ è½½åœ°å›¾');
                return;
            }

            const results = document.getElementById('results');
            results.innerHTML = 'ğŸ”„ æ­£åœ¨è§„åˆ’è·¯çº¿...';

            // ç®€åŒ–ç‰ˆè·¯çº¿è§„åˆ’ - åªæµ‹è¯•é©¾è½¦
            AMap.plugin('AMap.Driving', function() {
                const driving = new AMap.Driving({
                    map: map
                });

                driving.search([
                    {keyword: origin, city: 'åŒ—äº¬'},
                    {keyword: destination, city: 'åŒ—äº¬'}
                ], function(status, result) {
                    if (status === 'complete' && result.routes && result.routes.length > 0) {
                        const route = result.routes[0];
                        results.innerHTML = `
                            <div class="result-item">
                                <h4>ğŸš— é©¾è½¦è·¯çº¿</h4>
                                <p>è·ç¦»: ${(route.distance / 1000).toFixed(1)}å…¬é‡Œ</p>
                                <p>æ—¶é—´: ${Math.round(route.time / 60)}åˆ†é’Ÿ</p>
                                <p>è´¹ç”¨: Â¥${route.tolls || 0}</p>
                            </div>
                        `;
                    } else {
                        results.innerHTML = 'âŒ è·¯çº¿è§„åˆ’å¤±è´¥ï¼Œè¯·æ£€æŸ¥åœ°å€æ˜¯å¦æ­£ç¡®';
                    }
                });
            });
        }

        // æ¸…é™¤ç¼“å­˜åŠŸèƒ½
        function clearCache() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤ç¼“å­˜å—ï¼Ÿè¿™å°†åˆ·æ–°é¡µé¢å¹¶æ¸…é™¤æ‰€æœ‰ç¼“å­˜æ•°æ®ã€‚')) {
                try {
                    // æ¸…é™¤å„ç§ç¼“å­˜
                    if ('caches' in window) {
                        caches.keys().then(function(names) {
                            names.forEach(function(name) {
                                caches.delete(name);
                            });
                        });
                    }

                    // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                    if (typeof(Storage) !== "undefined") {
                        localStorage.clear();
                        sessionStorage.clear();
                    }

                    // æ¸…é™¤æ‰€æœ‰cookie
                    document.cookie.split(";").forEach(function(c) {
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                    });

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    alert('âœ… ç¼“å­˜å·²æ¸…é™¤ï¼é¡µé¢å°†é‡æ–°åŠ è½½ã€‚');

                    // å¼ºåˆ¶é‡æ–°åŠ è½½é¡µé¢ï¼ˆç»•è¿‡ç¼“å­˜ï¼‰
                    window.location.reload(true);

                } catch (error) {
                    console.error('æ¸…é™¤ç¼“å­˜æ—¶å‡ºé”™:', error);
                    alert('âš ï¸ éƒ¨åˆ†ç¼“å­˜å¯èƒ½æœªæ¸…é™¤ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢ (Ctrl+F5)');
                }
            }
        }

        // é‡æ–°åŠ è½½é¡µé¢
        function reloadPage() {
            if (confirm('ç¡®å®šè¦é‡æ–°åŠ è½½é¡µé¢å—ï¼Ÿ')) {
                // å¼ºåˆ¶é‡æ–°åŠ è½½ï¼ˆç»•è¿‡ç¼“å­˜ï¼‰
                window.location.reload(true);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºç¼“å­˜çŠ¶æ€
        window.addEventListener('load', function() {
            console.log('ğŸ“Š é¡µé¢åŠ è½½å®Œæˆ');
            console.log('ğŸ” ç¼“å­˜çŠ¶æ€æ£€æŸ¥:');
            console.log('- localStorage é¡¹ç›®æ•°:', localStorage.length);
            console.log('- sessionStorage é¡¹ç›®æ•°:', sessionStorage.length);
            console.log('- æ”¯æŒ Service Worker:', 'serviceWorker' in navigator);
            console.log('- æ”¯æŒ Cache API:', 'caches' in window);
        });
    </script>
</body>
</html>
