<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地铁公交换乘测试 - 高德地图路线规划</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            height: 80vh;
        }

        .control-panel {
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
        }

        .api-setup {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .api-setup h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .test-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .test-cases {
            display: grid;
            gap: 10px;
        }

        .test-case {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-case:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .test-case h4 {
            color: #333;
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        .test-case p {
            color: #666;
            font-size: 0.85em;
            margin: 0;
        }

        .map-container {
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .results-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 350px;
            max-height: calc(100% - 40px);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .results-overlay h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .route-result {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #52c41a;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .route-type {
            font-weight: 600;
            color: #333;
        }

        .route-time {
            background: #52c41a;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .route-details {
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
        }

        .route-segments {
            margin-top: 10px;
        }

        .segment {
            display: flex;
            align-items: center;
            margin: 5px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .segment-icon {
            margin-right: 8px;
            font-size: 1.1em;
        }

        .segment-text {
            font-size: 0.85em;
            color: #555;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.1em;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ff4d4f;
            font-size: 1.1em;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background: #52c41a;
        }

        .status-error {
            background: #ff4d4f;
        }

        .status-loading {
            background: #1890ff;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚇 地铁公交换乘测试</h1>
            <p>测试高德地图API的公共交通路线规划功能</p>
        </div>

        <div class="main-content">
            <div class="control-panel">
                <!-- API设置 -->
                <div class="api-setup">
                    <h3>🔑 API设置</h3>
                    <div class="input-group">
                        <label for="api-key">高德地图API密钥</label>
                        <input type="password" id="api-key" placeholder="请输入您的API密钥">
                    </div>
                    <button class="btn" id="save-api">保存并初始化地图</button>
                </div>

                <!-- 自定义测试 -->
                <div class="test-section">
                    <h3>🎯 自定义测试</h3>
                    <div class="input-group">
                        <label for="origin">出发地</label>
                        <input type="text" id="origin" placeholder="例如：北京站">
                    </div>
                    <div class="input-group">
                        <label for="destination">目的地</label>
                        <input type="text" id="destination" placeholder="例如：首都机场">
                    </div>
                    <button class="btn" id="test-custom">测试路线规划</button>
                </div>

                <!-- 预设测试用例 -->
                <div class="test-section">
                    <h3>🧪 预设测试用例</h3>
                    <div class="test-cases">
                        <div class="test-case" data-origin="北京站" data-destination="首都机场T3航站楼">
                            <h4>🚄 北京站 → 首都机场</h4>
                            <p>测试地铁+机场快轨换乘</p>
                        </div>
                        <div class="test-case" data-origin="天安门广场" data-destination="颐和园">
                            <h4>🏛️ 天安门 → 颐和园</h4>
                            <p>测试地铁+公交换乘</p>
                        </div>
                        <div class="test-case" data-origin="西单" data-destination="三里屯">
                            <h4>🛍️ 西单 → 三里屯</h4>
                            <p>测试地铁直达线路</p>
                        </div>
                        <div class="test-case" data-origin="上海虹桥火车站" data-destination="外滩">
                            <h4>🚅 虹桥站 → 外滩</h4>
                            <p>测试上海地铁换乘</p>
                        </div>
                        <div class="test-case" data-origin="广州南站" data-destination="广州塔">
                            <h4>🏗️ 广州南站 → 广州塔</h4>
                            <p>测试广州地铁线路</p>
                        </div>
                        <div class="test-case" data-origin="深圳北站" data-destination="世界之窗">
                            <h4>🌍 深圳北站 → 世界之窗</h4>
                            <p>测试深圳地铁换乘</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
                <div class="results-overlay" id="results-overlay" style="display: none;">
                    <h3>📊 路线规划结果</h3>
                    <div id="results-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let AMap;
        let apiKey = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            bindEvents();
            
            // 尝试从localStorage获取API密钥
            const storedKey = localStorage.getItem('amap_api_key');
            if (storedKey) {
                document.getElementById('api-key').value = storedKey;
                initializeMap(storedKey);
            }
        });

        // 绑定事件
        function bindEvents() {
            document.getElementById('save-api').addEventListener('click', saveApiKey);
            document.getElementById('test-custom').addEventListener('click', testCustomRoute);
            
            // 预设测试用例
            document.querySelectorAll('.test-case').forEach(testCase => {
                testCase.addEventListener('click', function() {
                    const origin = this.dataset.origin;
                    const destination = this.dataset.destination;
                    testTransitRoute(origin, destination);
                });
            });

            // 回车键触发测试
            document.getElementById('destination').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    testCustomRoute();
                }
            });
        }

        // 保存API密钥并初始化地图
        function saveApiKey() {
            const key = document.getElementById('api-key').value.trim();
            if (!key) {
                alert('请输入API密钥');
                return;
            }

            const btn = document.getElementById('save-api');
            btn.textContent = '🔄 初始化中...';
            btn.disabled = true;

            initializeMap(key).then(() => {
                localStorage.setItem('amap_api_key', key);
                apiKey = key;
                btn.textContent = '✅ 初始化成功';
                setTimeout(() => {
                    btn.textContent = '保存并初始化地图';
                    btn.disabled = false;
                }, 2000);
            }).catch(error => {
                console.error('地图初始化失败:', error);
                alert('API密钥验证失败，请检查密钥是否正确');
                btn.textContent = '保存并初始化地图';
                btn.disabled = false;
            });
        }

        // 初始化地图
        function initializeMap(key) {
            return new Promise((resolve, reject) => {
                // 移除旧脚本
                const oldScript = document.querySelector('script[src*="webapi.amap.com"]');
                if (oldScript) {
                    oldScript.remove();
                }

                // 重置AMap
                if (window.AMap) {
                    delete window.AMap;
                }

                const script = document.createElement('script');
                script.src = `https://webapi.amap.com/maps?v=1.4.15&key=${key}`;

                script.onload = () => {
                    if (window.AMap) {
                        AMap = window.AMap;
                        
                        // 创建地图实例
                        map = new AMap.Map('map', {
                            zoom: 11,
                            center: [116.397428, 39.90923], // 北京天安门
                            mapStyle: 'amap://styles/normal'
                        });

                        // 添加地图控件
                        AMap.plugin(['AMap.ToolBar', 'AMap.Scale'], function() {
                            map.addControl(new AMap.ToolBar({
                                position: 'RB'
                            }));
                            map.addControl(new AMap.Scale({
                                position: 'LB'
                            }));
                        });

                        console.log('地图初始化成功');
                        resolve(AMap);
                    } else {
                        reject(new Error('AMap对象未找到'));
                    }
                };

                script.onerror = () => {
                    reject(new Error('API脚本加载失败'));
                };

                document.head.appendChild(script);
            });
        }

        // 测试自定义路线
        function testCustomRoute() {
            const origin = document.getElementById('origin').value.trim();
            const destination = document.getElementById('destination').value.trim();

            if (!origin || !destination) {
                alert('请输入出发地和目的地');
                return;
            }

            testTransitRoute(origin, destination);
        }

        // 测试公交地铁路线
        function testTransitRoute(origin, destination) {
            if (!AMap || !map) {
                alert('请先初始化地图');
                return;
            }

            console.log(`开始测试路线: ${origin} → ${destination}`);
            
            // 显示结果面板
            const resultsOverlay = document.getElementById('results-overlay');
            const resultsContent = document.getElementById('results-content');
            resultsOverlay.style.display = 'block';
            resultsContent.innerHTML = '<div class="loading">🔄 正在规划路线...</div>';

            // 清除地图上的覆盖物
            map.clearMap();

            // 使用高德地图的Transfer服务进行公交路线规划
            AMap.plugin('AMap.Transfer', function() {
                // 创建Transfer实例，支持多种策略
                const strategies = [
                    { policy: AMap.TransferPolicy.LEAST_TIME, name: '最快路线' },
                    { policy: AMap.TransferPolicy.LEAST_FEE, name: '最省钱路线' },
                    { policy: AMap.TransferPolicy.LEAST_TRANSFER, name: '最少换乘' },
                    { policy: AMap.TransferPolicy.LEAST_WALK, name: '最少步行' }
                ];

                const results = [];
                let completed = 0;

                strategies.forEach((strategy, index) => {
                    const transfer = new AMap.Transfer({
                        map: index === 0 ? map : null, // 只在第一个策略上显示路线
                        city: '全国',
                        policy: strategy.policy,
                        nightflag: 1, // 包含夜班车
                        cityd: '全国' // 跨城市查询
                    });

                    transfer.search([
                        { keyword: origin },
                        { keyword: destination }
                    ], function(status, result) {
                        completed++;
                        
                        console.log(`${strategy.name} 查询结果:`, status, result);

                        if (status === 'complete' && result.plans && result.plans.length > 0) {
                            const plan = result.plans[0]; // 取第一个方案
                            results.push({
                                strategy: strategy.name,
                                plan: plan,
                                status: 'success'
                            });
                        } else {
                            const errorInfo = result.info || '查询失败';
                            results.push({
                                strategy: strategy.name,
                                error: errorInfo,
                                status: 'error',
                                isPermissionError: errorInfo === 'INVALID_USER_SCODE'
                            });
                        }

                        // 所有策略查询完成后显示结果
                        if (completed === strategies.length) {
                            displayTransitResults(results, origin, destination);
                        }
                    });
                });
            });
        }

        // 显示公交路线结果
        function displayTransitResults(results, origin, destination) {
            const resultsContent = document.getElementById('results-content');
            
            if (results.length === 0) {
                resultsContent.innerHTML = '<div class="error">❌ 未找到路线方案</div>';
                return;
            }

            let html = `
                <div style="margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-radius: 8px;">
                    <strong>📍 ${origin} → ${destination}</strong>
                </div>
            `;

            results.forEach((result, index) => {
                if (result.status === 'success') {
                    const plan = result.plan;
                    const time = Math.round(plan.time / 60); // 转换为分钟
                    const distance = (plan.distance / 1000).toFixed(1); // 转换为公里
                    const cost = plan.cost || 0;

                    html += `
                        <div class="route-result">
                            <div class="route-header">
                                <div class="route-type">
                                    <span class="status-indicator status-success"></span>
                                    🚌 ${result.strategy}
                                </div>
                                <div class="route-time">${time}分钟</div>
                            </div>
                            <div class="route-details">
                                <div>📏 距离: ${distance}公里</div>
                                <div>💰 费用: ¥${cost}</div>
                                <div>🔄 换乘: ${plan.transfers || 0}次</div>
                            </div>
                            <div class="route-segments">
                    `;

                    // 显示路线段落
                    if (plan.segments && plan.segments.length > 0) {
                        plan.segments.forEach(segment => {
                            if (segment.transit_mode === 'WALK') {
                                html += `
                                    <div class="segment">
                                        <span class="segment-icon">🚶</span>
                                        <span class="segment-text">步行 ${Math.round(segment.time / 60)}分钟</span>
                                    </div>
                                `;
                            } else if (segment.transit && segment.transit.length > 0) {
                                const transit = segment.transit[0];
                                const icon = getTransitIcon(transit.type);
                                html += `
                                    <div class="segment">
                                        <span class="segment-icon">${icon}</span>
                                        <span class="segment-text">${transit.name} (${transit.via_num || 0}站)</span>
                                    </div>
                                `;
                            }
                        });
                    }

                    html += `
                            </div>
                        </div>
                    `;
                } else {
                    // 特殊处理权限错误
                    if (result.isPermissionError) {
                        html += `
                            <div class="route-result" style="border-left-color: #faad14;">
                                <div class="route-header">
                                    <div class="route-type">
                                        <span class="status-indicator" style="background: #faad14;"></span>
                                        ⚠️ API权限问题
                                    </div>
                                </div>
                                <div class="route-details">
                                    <div style="color: #fa8c16; font-weight: bold;">INVALID_USER_SCODE</div>
                                    <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                                        当前API密钥未开通公交路径规划服务<br>
                                        请访问 <a href="https://console.amap.com/" target="_blank" style="color: #1890ff;">高德开放平台控制台</a> 检查服务权限
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="route-result">
                                <div class="route-header">
                                    <div class="route-type">
                                        <span class="status-indicator status-error"></span>
                                        ❌ ${result.strategy}
                                    </div>
                                </div>
                                <div class="route-details">
                                    <div style="color: #ff4d4f;">${result.error}</div>
                                </div>
                            </div>
                        `;
                    }
                }
            });

            resultsContent.innerHTML = html;

            // 调整地图视野以显示路线
            if (map) {
                map.setFitView();
            }
        }

        // 获取交通工具图标
        function getTransitIcon(type) {
            const icons = {
                '地铁': '🚇',
                '轻轨': '🚝',
                '公交': '🚌',
                '快速公交': '🚌',
                '有轨电车': '🚊',
                '磁悬浮': '🚝',
                '机场快线': '✈️'
            };
            
            // 根据类型匹配图标
            for (const [key, icon] of Object.entries(icons)) {
                if (type && type.includes(key)) {
                    return icon;
                }
            }
            
            return '🚌'; // 默认公交图标
        }

        // 地理编码函数
        function geocode(address) {
            return new Promise((resolve, reject) => {
                AMap.plugin('AMap.Geocoder', function() {
                    const geocoder = new AMap.Geocoder({
                        city: '全国',
                        extensions: 'all'
                    });
                    
                    geocoder.getLocation(address, function(status, result) {
                        if (status === 'complete' && result.geocodes && result.geocodes.length > 0) {
                            resolve(result.geocodes[0].location);
                        } else {
                            reject(new Error(`地址解析失败: ${address}`));
                        }
                    });
                });
            });
        }
    </script>
</body>
</html>
