<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°é“å…¬äº¤æ¢ä¹˜æµ‹è¯• - é«˜å¾·åœ°å›¾è·¯çº¿è§„åˆ’</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            height: 80vh;
        }

        .control-panel {
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
        }

        .api-setup {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .api-setup h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .test-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .test-cases {
            display: grid;
            gap: 10px;
        }

        .test-case {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-case:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .test-case h4 {
            color: #333;
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        .test-case p {
            color: #666;
            font-size: 0.85em;
            margin: 0;
        }

        .map-container {
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .results-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 350px;
            max-height: calc(100% - 40px);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .results-overlay h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .route-result {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #52c41a;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .route-type {
            font-weight: 600;
            color: #333;
        }

        .route-time {
            background: #52c41a;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .route-details {
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
        }

        .route-segments {
            margin-top: 10px;
        }

        .segment {
            display: flex;
            align-items: center;
            margin: 5px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .segment-icon {
            margin-right: 8px;
            font-size: 1.1em;
        }

        .segment-text {
            font-size: 0.85em;
            color: #555;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.1em;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ff4d4f;
            font-size: 1.1em;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background: #52c41a;
        }

        .status-error {
            background: #ff4d4f;
        }

        .status-loading {
            background: #1890ff;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš‡ åœ°é“å…¬äº¤æ¢ä¹˜æµ‹è¯•</h1>
            <p>æµ‹è¯•é«˜å¾·åœ°å›¾APIçš„å…¬å…±äº¤é€šè·¯çº¿è§„åˆ’åŠŸèƒ½</p>
        </div>

        <div class="main-content">
            <div class="control-panel">
                <!-- APIè®¾ç½® -->
                <div class="api-setup">
                    <h3>ğŸ”‘ APIè®¾ç½®</h3>
                    <div class="input-group">
                        <label for="api-key">é«˜å¾·åœ°å›¾APIå¯†é’¥</label>
                        <input type="password" id="api-key" placeholder="è¯·è¾“å…¥æ‚¨çš„APIå¯†é’¥">
                    </div>
                    <button class="btn" id="save-api">ä¿å­˜å¹¶åˆå§‹åŒ–åœ°å›¾</button>
                </div>

                <!-- è‡ªå®šä¹‰æµ‹è¯• -->
                <div class="test-section">
                    <h3>ğŸ¯ è‡ªå®šä¹‰æµ‹è¯•</h3>
                    <div class="input-group">
                        <label for="origin">å‡ºå‘åœ°</label>
                        <input type="text" id="origin" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬ç«™">
                    </div>
                    <div class="input-group">
                        <label for="destination">ç›®çš„åœ°</label>
                        <input type="text" id="destination" placeholder="ä¾‹å¦‚ï¼šé¦–éƒ½æœºåœº">
                    </div>
                    <button class="btn" id="test-custom">æµ‹è¯•è·¯çº¿è§„åˆ’</button>
                </div>

                <!-- é¢„è®¾æµ‹è¯•ç”¨ä¾‹ -->
                <div class="test-section">
                    <h3>ğŸ§ª é¢„è®¾æµ‹è¯•ç”¨ä¾‹</h3>
                    <div class="test-cases">
                        <div class="test-case" data-origin="åŒ—äº¬ç«™" data-destination="é¦–éƒ½æœºåœºT3èˆªç«™æ¥¼">
                            <h4>ğŸš„ åŒ—äº¬ç«™ â†’ é¦–éƒ½æœºåœº</h4>
                            <p>æµ‹è¯•åœ°é“+æœºåœºå¿«è½¨æ¢ä¹˜</p>
                        </div>
                        <div class="test-case" data-origin="å¤©å®‰é—¨å¹¿åœº" data-destination="é¢å’Œå›­">
                            <h4>ğŸ›ï¸ å¤©å®‰é—¨ â†’ é¢å’Œå›­</h4>
                            <p>æµ‹è¯•åœ°é“+å…¬äº¤æ¢ä¹˜</p>
                        </div>
                        <div class="test-case" data-origin="è¥¿å•" data-destination="ä¸‰é‡Œå±¯">
                            <h4>ğŸ›ï¸ è¥¿å• â†’ ä¸‰é‡Œå±¯</h4>
                            <p>æµ‹è¯•åœ°é“ç›´è¾¾çº¿è·¯</p>
                        </div>
                        <div class="test-case" data-origin="ä¸Šæµ·è™¹æ¡¥ç«è½¦ç«™" data-destination="å¤–æ»©">
                            <h4>ğŸš… è™¹æ¡¥ç«™ â†’ å¤–æ»©</h4>
                            <p>æµ‹è¯•ä¸Šæµ·åœ°é“æ¢ä¹˜</p>
                        </div>
                        <div class="test-case" data-origin="å¹¿å·å—ç«™" data-destination="å¹¿å·å¡”">
                            <h4>ğŸ—ï¸ å¹¿å·å—ç«™ â†’ å¹¿å·å¡”</h4>
                            <p>æµ‹è¯•å¹¿å·åœ°é“çº¿è·¯</p>
                        </div>
                        <div class="test-case" data-origin="æ·±åœ³åŒ—ç«™" data-destination="ä¸–ç•Œä¹‹çª—">
                            <h4>ğŸŒ æ·±åœ³åŒ—ç«™ â†’ ä¸–ç•Œä¹‹çª—</h4>
                            <p>æµ‹è¯•æ·±åœ³åœ°é“æ¢ä¹˜</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
                <div class="results-overlay" id="results-overlay" style="display: none;">
                    <h3>ğŸ“Š è·¯çº¿è§„åˆ’ç»“æœ</h3>
                    <div id="results-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let AMap;
        let apiKey = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            bindEvents();
            
            // å°è¯•ä»localStorageè·å–APIå¯†é’¥
            const storedKey = localStorage.getItem('amap_api_key');
            if (storedKey) {
                document.getElementById('api-key').value = storedKey;
                initializeMap(storedKey);
            }
        });

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            document.getElementById('save-api').addEventListener('click', saveApiKey);
            document.getElementById('test-custom').addEventListener('click', testCustomRoute);
            
            // é¢„è®¾æµ‹è¯•ç”¨ä¾‹
            document.querySelectorAll('.test-case').forEach(testCase => {
                testCase.addEventListener('click', function() {
                    const origin = this.dataset.origin;
                    const destination = this.dataset.destination;
                    testTransitRoute(origin, destination);
                });
            });

            // å›è½¦é”®è§¦å‘æµ‹è¯•
            document.getElementById('destination').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    testCustomRoute();
                }
            });
        }

        // ä¿å­˜APIå¯†é’¥å¹¶åˆå§‹åŒ–åœ°å›¾
        function saveApiKey() {
            const key = document.getElementById('api-key').value.trim();
            if (!key) {
                alert('è¯·è¾“å…¥APIå¯†é’¥');
                return;
            }

            const btn = document.getElementById('save-api');
            btn.textContent = 'ğŸ”„ åˆå§‹åŒ–ä¸­...';
            btn.disabled = true;

            initializeMap(key).then(() => {
                localStorage.setItem('amap_api_key', key);
                apiKey = key;
                btn.textContent = 'âœ… åˆå§‹åŒ–æˆåŠŸ';
                setTimeout(() => {
                    btn.textContent = 'ä¿å­˜å¹¶åˆå§‹åŒ–åœ°å›¾';
                    btn.disabled = false;
                }, 2000);
            }).catch(error => {
                console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                alert('APIå¯†é’¥éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†é’¥æ˜¯å¦æ­£ç¡®');
                btn.textContent = 'ä¿å­˜å¹¶åˆå§‹åŒ–åœ°å›¾';
                btn.disabled = false;
            });
        }

        // åˆå§‹åŒ–åœ°å›¾
        function initializeMap(key) {
            return new Promise((resolve, reject) => {
                // ç§»é™¤æ—§è„šæœ¬
                const oldScript = document.querySelector('script[src*="webapi.amap.com"]');
                if (oldScript) {
                    oldScript.remove();
                }

                // é‡ç½®AMap
                if (window.AMap) {
                    delete window.AMap;
                }

                const script = document.createElement('script');
                script.src = `https://webapi.amap.com/maps?v=1.4.15&key=${key}`;

                script.onload = () => {
                    if (window.AMap) {
                        AMap = window.AMap;
                        
                        // åˆ›å»ºåœ°å›¾å®ä¾‹
                        map = new AMap.Map('map', {
                            zoom: 11,
                            center: [116.397428, 39.90923], // åŒ—äº¬å¤©å®‰é—¨
                            mapStyle: 'amap://styles/normal'
                        });

                        // æ·»åŠ åœ°å›¾æ§ä»¶
                        AMap.plugin(['AMap.ToolBar', 'AMap.Scale'], function() {
                            map.addControl(new AMap.ToolBar({
                                position: 'RB'
                            }));
                            map.addControl(new AMap.Scale({
                                position: 'LB'
                            }));
                        });

                        console.log('åœ°å›¾åˆå§‹åŒ–æˆåŠŸ');
                        resolve(AMap);
                    } else {
                        reject(new Error('AMapå¯¹è±¡æœªæ‰¾åˆ°'));
                    }
                };

                script.onerror = () => {
                    reject(new Error('APIè„šæœ¬åŠ è½½å¤±è´¥'));
                };

                document.head.appendChild(script);
            });
        }

        // æµ‹è¯•è‡ªå®šä¹‰è·¯çº¿
        function testCustomRoute() {
            const origin = document.getElementById('origin').value.trim();
            const destination = document.getElementById('destination').value.trim();

            if (!origin || !destination) {
                alert('è¯·è¾“å…¥å‡ºå‘åœ°å’Œç›®çš„åœ°');
                return;
            }

            testTransitRoute(origin, destination);
        }

        // æµ‹è¯•å…¬äº¤åœ°é“è·¯çº¿
        function testTransitRoute(origin, destination) {
            if (!AMap || !map) {
                alert('è¯·å…ˆåˆå§‹åŒ–åœ°å›¾');
                return;
            }

            console.log(`å¼€å§‹æµ‹è¯•è·¯çº¿: ${origin} â†’ ${destination}`);
            
            // æ˜¾ç¤ºç»“æœé¢æ¿
            const resultsOverlay = document.getElementById('results-overlay');
            const resultsContent = document.getElementById('results-content');
            resultsOverlay.style.display = 'block';
            resultsContent.innerHTML = '<div class="loading">ğŸ”„ æ­£åœ¨è§„åˆ’è·¯çº¿...</div>';

            // æ¸…é™¤åœ°å›¾ä¸Šçš„è¦†ç›–ç‰©
            map.clearMap();

            // ä½¿ç”¨é«˜å¾·åœ°å›¾çš„TransferæœåŠ¡è¿›è¡Œå…¬äº¤è·¯çº¿è§„åˆ’
            AMap.plugin('AMap.Transfer', function() {
                // åˆ›å»ºTransferå®ä¾‹ï¼Œæ”¯æŒå¤šç§ç­–ç•¥
                const strategies = [
                    { policy: AMap.TransferPolicy.LEAST_TIME, name: 'æœ€å¿«è·¯çº¿' },
                    { policy: AMap.TransferPolicy.LEAST_FEE, name: 'æœ€çœé’±è·¯çº¿' },
                    { policy: AMap.TransferPolicy.LEAST_TRANSFER, name: 'æœ€å°‘æ¢ä¹˜' },
                    { policy: AMap.TransferPolicy.LEAST_WALK, name: 'æœ€å°‘æ­¥è¡Œ' }
                ];

                const results = [];
                let completed = 0;

                strategies.forEach((strategy, index) => {
                    const transfer = new AMap.Transfer({
                        map: index === 0 ? map : null, // åªåœ¨ç¬¬ä¸€ä¸ªç­–ç•¥ä¸Šæ˜¾ç¤ºè·¯çº¿
                        city: 'å…¨å›½',
                        policy: strategy.policy,
                        nightflag: 1, // åŒ…å«å¤œç­è½¦
                        cityd: 'å…¨å›½' // è·¨åŸå¸‚æŸ¥è¯¢
                    });

                    transfer.search([
                        { keyword: origin },
                        { keyword: destination }
                    ], function(status, result) {
                        completed++;
                        
                        console.log(`${strategy.name} æŸ¥è¯¢ç»“æœ:`, status, result);

                        if (status === 'complete' && result.plans && result.plans.length > 0) {
                            const plan = result.plans[0]; // å–ç¬¬ä¸€ä¸ªæ–¹æ¡ˆ
                            results.push({
                                strategy: strategy.name,
                                plan: plan,
                                status: 'success'
                            });
                        } else {
                            const errorInfo = result.info || 'æŸ¥è¯¢å¤±è´¥';
                            results.push({
                                strategy: strategy.name,
                                error: errorInfo,
                                status: 'error',
                                isPermissionError: errorInfo === 'INVALID_USER_SCODE'
                            });
                        }

                        // æ‰€æœ‰ç­–ç•¥æŸ¥è¯¢å®Œæˆåæ˜¾ç¤ºç»“æœ
                        if (completed === strategies.length) {
                            displayTransitResults(results, origin, destination);
                        }
                    });
                });
            });
        }

        // æ˜¾ç¤ºå…¬äº¤è·¯çº¿ç»“æœ
        function displayTransitResults(results, origin, destination) {
            const resultsContent = document.getElementById('results-content');
            
            if (results.length === 0) {
                resultsContent.innerHTML = '<div class="error">âŒ æœªæ‰¾åˆ°è·¯çº¿æ–¹æ¡ˆ</div>';
                return;
            }

            let html = `
                <div style="margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-radius: 8px;">
                    <strong>ğŸ“ ${origin} â†’ ${destination}</strong>
                </div>
            `;

            results.forEach((result, index) => {
                if (result.status === 'success') {
                    const plan = result.plan;
                    const time = Math.round(plan.time / 60); // è½¬æ¢ä¸ºåˆ†é’Ÿ
                    const distance = (plan.distance / 1000).toFixed(1); // è½¬æ¢ä¸ºå…¬é‡Œ
                    const cost = plan.cost || 0;

                    html += `
                        <div class="route-result">
                            <div class="route-header">
                                <div class="route-type">
                                    <span class="status-indicator status-success"></span>
                                    ğŸšŒ ${result.strategy}
                                </div>
                                <div class="route-time">${time}åˆ†é’Ÿ</div>
                            </div>
                            <div class="route-details">
                                <div>ğŸ“ è·ç¦»: ${distance}å…¬é‡Œ</div>
                                <div>ğŸ’° è´¹ç”¨: Â¥${cost}</div>
                                <div>ğŸ”„ æ¢ä¹˜: ${plan.transfers || 0}æ¬¡</div>
                            </div>
                            <div class="route-segments">
                    `;

                    // æ˜¾ç¤ºè·¯çº¿æ®µè½
                    if (plan.segments && plan.segments.length > 0) {
                        plan.segments.forEach(segment => {
                            if (segment.transit_mode === 'WALK') {
                                html += `
                                    <div class="segment">
                                        <span class="segment-icon">ğŸš¶</span>
                                        <span class="segment-text">æ­¥è¡Œ ${Math.round(segment.time / 60)}åˆ†é’Ÿ</span>
                                    </div>
                                `;
                            } else if (segment.transit && segment.transit.length > 0) {
                                const transit = segment.transit[0];
                                const icon = getTransitIcon(transit.type);
                                html += `
                                    <div class="segment">
                                        <span class="segment-icon">${icon}</span>
                                        <span class="segment-text">${transit.name} (${transit.via_num || 0}ç«™)</span>
                                    </div>
                                `;
                            }
                        });
                    }

                    html += `
                            </div>
                        </div>
                    `;
                } else {
                    // ç‰¹æ®Šå¤„ç†æƒé™é”™è¯¯
                    if (result.isPermissionError) {
                        html += `
                            <div class="route-result" style="border-left-color: #faad14;">
                                <div class="route-header">
                                    <div class="route-type">
                                        <span class="status-indicator" style="background: #faad14;"></span>
                                        âš ï¸ APIæƒé™é—®é¢˜
                                    </div>
                                </div>
                                <div class="route-details">
                                    <div style="color: #fa8c16; font-weight: bold;">INVALID_USER_SCODE</div>
                                    <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                                        å½“å‰APIå¯†é’¥æœªå¼€é€šå…¬äº¤è·¯å¾„è§„åˆ’æœåŠ¡<br>
                                        è¯·è®¿é—® <a href="https://console.amap.com/" target="_blank" style="color: #1890ff;">é«˜å¾·å¼€æ”¾å¹³å°æ§åˆ¶å°</a> æ£€æŸ¥æœåŠ¡æƒé™
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="route-result">
                                <div class="route-header">
                                    <div class="route-type">
                                        <span class="status-indicator status-error"></span>
                                        âŒ ${result.strategy}
                                    </div>
                                </div>
                                <div class="route-details">
                                    <div style="color: #ff4d4f;">${result.error}</div>
                                </div>
                            </div>
                        `;
                    }
                }
            });

            resultsContent.innerHTML = html;

            // è°ƒæ•´åœ°å›¾è§†é‡ä»¥æ˜¾ç¤ºè·¯çº¿
            if (map) {
                map.setFitView();
            }
        }

        // è·å–äº¤é€šå·¥å…·å›¾æ ‡
        function getTransitIcon(type) {
            const icons = {
                'åœ°é“': 'ğŸš‡',
                'è½»è½¨': 'ğŸš',
                'å…¬äº¤': 'ğŸšŒ',
                'å¿«é€Ÿå…¬äº¤': 'ğŸšŒ',
                'æœ‰è½¨ç”µè½¦': 'ğŸšŠ',
                'ç£æ‚¬æµ®': 'ğŸš',
                'æœºåœºå¿«çº¿': 'âœˆï¸'
            };
            
            // æ ¹æ®ç±»å‹åŒ¹é…å›¾æ ‡
            for (const [key, icon] of Object.entries(icons)) {
                if (type && type.includes(key)) {
                    return icon;
                }
            }
            
            return 'ğŸšŒ'; // é»˜è®¤å…¬äº¤å›¾æ ‡
        }

        // åœ°ç†ç¼–ç å‡½æ•°
        function geocode(address) {
            return new Promise((resolve, reject) => {
                AMap.plugin('AMap.Geocoder', function() {
                    const geocoder = new AMap.Geocoder({
                        city: 'å…¨å›½',
                        extensions: 'all'
                    });
                    
                    geocoder.getLocation(address, function(status, result) {
                        if (status === 'complete' && result.geocodes && result.geocodes.length > 0) {
                            resolve(result.geocodes[0].location);
                        } else {
                            reject(new Error(`åœ°å€è§£æå¤±è´¥: ${address}`));
                        }
                    });
                });
            });
        }
    </script>
</body>
</html>
