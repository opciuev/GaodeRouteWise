<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜å¾·APIè¯¦ç»†è¯Šæ–­</title>
    <script>
        window._AMapSecurityConfig = {
            securityJsCode: "db2b6cf5ae4f82ee233b1abe16aa459a",
        }
    </script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; white-space: pre-wrap; font-family: monospace; font-size: 12px; }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .warning { border-left-color: #ffc107; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 300px; }
        #map { width: 100%; height: 300px; border: 1px solid #ddd; margin: 10px 0; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” é«˜å¾·åœ°å›¾APIè¯¦ç»†è¯Šæ–­å·¥å…·</h1>
        
        <div class="section">
            <h3>1. APIå¯†é’¥åŠ è½½</h3>
            <input type="password" id="apiKey" placeholder="è¾“å…¥APIå¯†é’¥">
            <button onclick="loadAPI()">åŠ è½½API</button>
            <div id="apiResult" class="result">è¯·è¾“å…¥APIå¯†é’¥</div>
        </div>

        <div class="section">
            <h3>2. åœ°å›¾åˆ›å»º</h3>
            <button onclick="createMap()">åˆ›å»ºåœ°å›¾</button>
            <div id="map"></div>
            <div id="mapResult" class="result">è¯·å…ˆåŠ è½½API</div>
        </div>

        <div class="section">
            <h3>3. è¯¦ç»†é”™è¯¯è¯Šæ–­</h3>
            <button onclick="runFullDiagnostic()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
            <div id="diagnosticResult" class="result">è¯·å…ˆåˆ›å»ºåœ°å›¾</div>
        </div>

        <div class="section">
            <h3>4. å•é¡¹æµ‹è¯•</h3>
            <button onclick="testGeocoder()">æµ‹è¯•åœ°ç†ç¼–ç </button>
            <button onclick="testDriving()">æµ‹è¯•é©¾è½¦è§„åˆ’</button>
            <button onclick="testWalking()">æµ‹è¯•æ­¥è¡Œè§„åˆ’</button>
            <button onclick="testTransfer()">æµ‹è¯•å…¬äº¤è§„åˆ’</button>
            <div id="singleTestResult" class="result">ç‚¹å‡»æŒ‰é’®è¿›è¡Œå•é¡¹æµ‹è¯•</div>
        </div>
    </div>

    <script>
        let AMap;
        let map;

        function loadAPI() {
            const key = document.getElementById('apiKey').value.trim();
            const result = document.getElementById('apiResult');
            
            if (!key) {
                result.innerHTML = 'âŒ è¯·è¾“å…¥APIå¯†é’¥';
                result.className = 'result error';
                return;
            }

            result.innerHTML = 'ğŸ”„ æ­£åœ¨åŠ è½½API...';
            result.className = 'result';

            // ç§»é™¤æ—§è„šæœ¬
            const oldScript = document.querySelector('script[src*="webapi.amap.com"]');
            if (oldScript) oldScript.remove();

            const script = document.createElement('script');
            script.src = `https://webapi.amap.com/maps?v=1.4.15&key=${key}`;
            
            script.onload = () => {
                if (window.AMap) {
                    AMap = window.AMap;
                    result.innerHTML = `âœ… APIåŠ è½½æˆåŠŸï¼
APIå¯†é’¥: ${key.substring(0, 8)}...
AMapå¯¹è±¡: ${typeof AMap}
å¯ç”¨æ’ä»¶: ${Object.keys(AMap).filter(k => k.startsWith('plugin') || k.includes('Plugin')).join(', ') || 'éœ€è¦åŠ¨æ€åŠ è½½'}`;
                    result.className = 'result success';
                } else {
                    result.innerHTML = 'âŒ APIå¯¹è±¡æœªæ‰¾åˆ°';
                    result.className = 'result error';
                }
            };
            
            script.onerror = () => {
                result.innerHTML = 'âŒ ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½API';
                result.className = 'result error';
            };
            
            document.head.appendChild(script);
        }

        function createMap() {
            const result = document.getElementById('mapResult');
            
            if (!AMap) {
                result.innerHTML = 'âŒ è¯·å…ˆåŠ è½½API';
                result.className = 'result error';
                return;
            }

            try {
                map = new AMap.Map('map', {
                    zoom: 11,
                    center: [116.397428, 39.90923]
                });
                
                map.on('complete', function() {
                    result.innerHTML = `âœ… åœ°å›¾åˆ›å»ºæˆåŠŸï¼
åœ°å›¾ä¸­å¿ƒ: [116.397428, 39.90923]
ç¼©æ”¾çº§åˆ«: 11
åœ°å›¾çŠ¶æ€: å·²åŠ è½½å®Œæˆ`;
                    result.className = 'result success';
                });

                map.on('error', function(error) {
                    result.innerHTML = `âŒ åœ°å›¾åŠ è½½é”™è¯¯: ${JSON.stringify(error)}`;
                    result.className = 'result error';
                });

            } catch (error) {
                result.innerHTML = `âŒ åœ°å›¾åˆ›å»ºå¤±è´¥: ${error.message}
é”™è¯¯å †æ ˆ: ${error.stack}`;
                result.className = 'result error';
            }
        }

        function runFullDiagnostic() {
            const result = document.getElementById('diagnosticResult');
            
            if (!AMap || !map) {
                result.innerHTML = 'âŒ è¯·å…ˆåˆ›å»ºåœ°å›¾';
                result.className = 'result error';
                return;
            }

            result.innerHTML = 'ğŸ”„ æ­£åœ¨è¿è¡Œå®Œæ•´è¯Šæ–­...';
            result.className = 'result';

            let diagnosticResults = [];
            let completedTests = 0;
            const totalTests = 5;

            function addResult(testName, success, message, details = '') {
                diagnosticResults.push({
                    test: testName,
                    success: success,
                    message: message,
                    details: details
                });
                completedTests++;
                
                if (completedTests === totalTests) {
                    displayDiagnosticResults();
                }
            }

            function displayDiagnosticResults() {
                const successCount = diagnosticResults.filter(r => r.success).length;
                let output = `è¯Šæ–­å®Œæˆ (${successCount}/${totalTests} æˆåŠŸ):\n\n`;
                
                diagnosticResults.forEach(r => {
                    output += `${r.success ? 'âœ…' : 'âŒ'} ${r.test}: ${r.message}\n`;
                    if (r.details) output += `   è¯¦æƒ…: ${r.details}\n`;
                    output += '\n';
                });

                if (successCount === 0) {
                    output += `ğŸš¨ æ‰€æœ‰æœåŠ¡éƒ½å¤±è´¥ï¼Œå¯èƒ½çš„åŸå› ï¼š
1. APIå¯†é’¥æƒé™ä¸è¶³ - è¯·æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦å¼€é€šäº†ç›¸åº”æœåŠ¡
2. APIå¯†é’¥é…ç½®é”™è¯¯ - è¯·æ£€æŸ¥ç™½åå•è®¾ç½®
3. ç½‘ç»œé—®é¢˜ - è¯·æ£€æŸ¥æ˜¯å¦æœ‰å¹¿å‘Šæ‹¦æˆªå™¨
4. æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ - è¯·ç¨åé‡è¯•

å»ºè®®æ“ä½œï¼š
1. ç™»å½•é«˜å¾·å¼€æ”¾å¹³å°æ§åˆ¶å°æ£€æŸ¥APIå¯†é’¥çŠ¶æ€
2. ç¡®ä¿å¼€é€šäº†åœ°ç†ç¼–ç ã€è·¯å¾„è§„åˆ’ç­‰æœåŠ¡
3. æ£€æŸ¥ç™½åå•æ˜¯å¦åŒ…å«å½“å‰åŸŸå
4. æš‚æ—¶å…³é—­å¹¿å‘Šæ‹¦æˆªå™¨é‡è¯•`;
                }

                result.innerHTML = output;
                result.className = successCount > 0 ? 'result warning' : 'result error';
            }

            // æµ‹è¯•1: åŸºç¡€åœ°å›¾åŠŸèƒ½
            try {
                map.setZoom(12);
                addResult('åŸºç¡€åœ°å›¾åŠŸèƒ½', true, 'åœ°å›¾æ“ä½œæ­£å¸¸');
            } catch (error) {
                addResult('åŸºç¡€åœ°å›¾åŠŸèƒ½', false, 'åœ°å›¾æ“ä½œå¤±è´¥', error.message);
            }

            // æµ‹è¯•2: åœ°ç†ç¼–ç 
            AMap.plugin('AMap.Geocoder', function() {
                const geocoder = new AMap.Geocoder();
                geocoder.getLocation('åŒ—äº¬', function(status, geocodeResult) {
                    if (status === 'complete' && geocodeResult.geocodes && geocodeResult.geocodes.length > 0) {
                        addResult('åœ°ç†ç¼–ç æœåŠ¡', true, 'åœ°ç†ç¼–ç æ­£å¸¸');
                    } else {
                        addResult('åœ°ç†ç¼–ç æœåŠ¡', false, `åœ°ç†ç¼–ç å¤±è´¥: ${status}`, JSON.stringify(geocodeResult));
                    }
                });
            });

            // æµ‹è¯•3: é©¾è½¦è§„åˆ’
            AMap.plugin('AMap.Driving', function() {
                const driving = new AMap.Driving();
                const origin = new AMap.LngLat(116.397428, 39.90923);
                const destination = new AMap.LngLat(116.322287, 39.893729);
                
                driving.search(origin, destination, function(status, drivingResult) {
                    if (status === 'complete' && drivingResult.routes && drivingResult.routes.length > 0) {
                        addResult('é©¾è½¦è·¯çº¿è§„åˆ’', true, 'é©¾è½¦è§„åˆ’æ­£å¸¸');
                    } else {
                        addResult('é©¾è½¦è·¯çº¿è§„åˆ’', false, `é©¾è½¦è§„åˆ’å¤±è´¥: ${status}`, JSON.stringify(drivingResult));
                    }
                });
            });

            // æµ‹è¯•4: æ­¥è¡Œè§„åˆ’
            AMap.plugin('AMap.Walking', function() {
                const walking = new AMap.Walking();
                const origin = new AMap.LngLat(116.397428, 39.90923);
                const destination = new AMap.LngLat(116.322287, 39.893729);
                
                walking.search(origin, destination, function(status, walkingResult) {
                    if (status === 'complete' && walkingResult.routes && walkingResult.routes.length > 0) {
                        addResult('æ­¥è¡Œè·¯çº¿è§„åˆ’', true, 'æ­¥è¡Œè§„åˆ’æ­£å¸¸');
                    } else {
                        addResult('æ­¥è¡Œè·¯çº¿è§„åˆ’', false, `æ­¥è¡Œè§„åˆ’å¤±è´¥: ${status}`, JSON.stringify(walkingResult));
                    }
                });
            });

            // æµ‹è¯•5: å…¬äº¤è§„åˆ’
            AMap.plugin('AMap.Transfer', function() {
                const transfer = new AMap.Transfer({
                    city: 'åŒ—äº¬'
                });
                const origin = new AMap.LngLat(116.397428, 39.90923);
                const destination = new AMap.LngLat(116.322287, 39.893729);
                
                transfer.search(origin, destination, function(status, transferResult) {
                    if (status === 'complete' && transferResult.plans && transferResult.plans.length > 0) {
                        addResult('å…¬äº¤è·¯çº¿è§„åˆ’', true, 'å…¬äº¤è§„åˆ’æ­£å¸¸');
                    } else {
                        addResult('å…¬äº¤è·¯çº¿è§„åˆ’', false, `å…¬äº¤è§„åˆ’å¤±è´¥: ${status}`, JSON.stringify(transferResult));
                    }
                });
            });
        }

        function testGeocoder() {
            const result = document.getElementById('singleTestResult');
            
            if (!AMap) {
                result.innerHTML = 'âŒ è¯·å…ˆåŠ è½½API';
                result.className = 'result error';
                return;
            }

            result.innerHTML = 'ğŸ”„ æµ‹è¯•åœ°ç†ç¼–ç ...';
            result.className = 'result';

            AMap.plugin('AMap.Geocoder', function() {
                const geocoder = new AMap.Geocoder();
                geocoder.getLocation('å¤©å®‰é—¨', function(status, geocodeResult) {
                    result.innerHTML = `åœ°ç†ç¼–ç æµ‹è¯•ç»“æœ:
çŠ¶æ€: ${status}
å®Œæ•´å“åº”: ${JSON.stringify(geocodeResult, null, 2)}`;
                    result.className = status === 'complete' ? 'result success' : 'result error';
                });
            });
        }

        function testDriving() {
            const result = document.getElementById('singleTestResult');
            
            if (!AMap) {
                result.innerHTML = 'âŒ è¯·å…ˆåŠ è½½API';
                result.className = 'result error';
                return;
            }

            result.innerHTML = 'ğŸ”„ æµ‹è¯•é©¾è½¦è§„åˆ’...';
            result.className = 'result';

            AMap.plugin('AMap.Driving', function() {
                const driving = new AMap.Driving();
                const origin = new AMap.LngLat(116.397428, 39.90923);
                const destination = new AMap.LngLat(116.322287, 39.893729);
                
                driving.search(origin, destination, function(status, drivingResult) {
                    result.innerHTML = `é©¾è½¦è§„åˆ’æµ‹è¯•ç»“æœ:
çŠ¶æ€: ${status}
å®Œæ•´å“åº”: ${JSON.stringify(drivingResult, null, 2)}`;
                    result.className = status === 'complete' ? 'result success' : 'result error';
                });
            });
        }

        function testWalking() {
            const result = document.getElementById('singleTestResult');
            
            if (!AMap) {
                result.innerHTML = 'âŒ è¯·å…ˆåŠ è½½API';
                result.className = 'result error';
                return;
            }

            result.innerHTML = 'ğŸ”„ æµ‹è¯•æ­¥è¡Œè§„åˆ’...';
            result.className = 'result';

            AMap.plugin('AMap.Walking', function() {
                const walking = new AMap.Walking();
                const origin = new AMap.LngLat(116.397428, 39.90923);
                const destination = new AMap.LngLat(116.322287, 39.893729);
                
                walking.search(origin, destination, function(status, walkingResult) {
                    result.innerHTML = `æ­¥è¡Œè§„åˆ’æµ‹è¯•ç»“æœ:
çŠ¶æ€: ${status}
å®Œæ•´å“åº”: ${JSON.stringify(walkingResult, null, 2)}`;
                    result.className = status === 'complete' ? 'result success' : 'result error';
                });
            });
        }

        function testTransfer() {
            const result = document.getElementById('singleTestResult');
            
            if (!AMap) {
                result.innerHTML = 'âŒ è¯·å…ˆåŠ è½½API';
                result.className = 'result error';
                return;
            }

            result.innerHTML = 'ğŸ”„ æµ‹è¯•å…¬äº¤è§„åˆ’...';
            result.className = 'result';

            AMap.plugin('AMap.Transfer', function() {
                const transfer = new AMap.Transfer({
                    city: 'åŒ—äº¬'
                });
                const origin = new AMap.LngLat(116.397428, 39.90923);
                const destination = new AMap.LngLat(116.322287, 39.893729);
                
                transfer.search(origin, destination, function(status, transferResult) {
                    result.innerHTML = `å…¬äº¤è§„åˆ’æµ‹è¯•ç»“æœ:
çŠ¶æ€: ${status}
å®Œæ•´å“åº”: ${JSON.stringify(transferResult, null, 2)}`;
                    result.className = status === 'complete' ? 'result success' : 'result error';
                });
            });
        }
    </script>
</body>
</html>
