<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜å¾·APIè¯Šæ–­å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .result {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #52c41a;
        }

        .result.error {
            border-left-color: #ff4d4f;
            background: #fff2f0;
        }

        .result.warning {
            border-left-color: #faad14;
            background: #fffbe6;
        }

        .code {
            background: #f6f8fa;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .status-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .status-item.success {
            border-color: #52c41a;
            background: #f6ffed;
        }

        .status-item.error {
            border-color: #ff4d4f;
            background: #fff2f0;
        }

        .status-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .fix-steps {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .fix-steps h4 {
            color: #1890ff;
            margin-bottom: 15px;
        }

        .fix-steps ol {
            padding-left: 20px;
        }

        .fix-steps li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ é«˜å¾·APIè¯Šæ–­å·¥å…·</h1>
            <p>æ£€æµ‹APIå¯†é’¥æƒé™å’ŒæœåŠ¡é…ç½®é—®é¢˜</p>
        </div>

        <div class="content">
            <!-- APIå¯†é’¥è¾“å…¥ -->
            <div class="section">
                <h3>ğŸ”‘ APIå¯†é’¥è®¾ç½®</h3>
                <div class="input-group">
                    <label for="api-key">é«˜å¾·åœ°å›¾APIå¯†é’¥</label>
                    <input type="password" id="api-key" placeholder="è¯·è¾“å…¥æ‚¨çš„APIå¯†é’¥">
                </div>
                <button class="btn" id="start-diagnosis">å¼€å§‹è¯Šæ–­</button>
                <button class="btn" id="clear-results">æ¸…é™¤ç»“æœ</button>
            </div>

            <!-- è¯Šæ–­ç»“æœ -->
            <div class="section" id="diagnosis-section" style="display: none;">
                <h3>ğŸ“Š è¯Šæ–­ç»“æœ</h3>
                <div class="status-grid" id="status-grid"></div>
                <div id="detailed-results"></div>
            </div>

            <!-- è§£å†³æ–¹æ¡ˆ -->
            <div class="section" id="solution-section" style="display: none;">
                <h3>ğŸ’¡ è§£å†³æ–¹æ¡ˆ</h3>
                <div id="solution-content"></div>
            </div>
        </div>
    </div>

    <script>
        let AMap;
        let apiKey;

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('start-diagnosis').addEventListener('click', startDiagnosis);
            document.getElementById('clear-results').addEventListener('click', clearResults);
        });

        async function startDiagnosis() {
            apiKey = document.getElementById('api-key').value.trim();
            if (!apiKey) {
                alert('è¯·è¾“å…¥APIå¯†é’¥');
                return;
            }

            const btn = document.getElementById('start-diagnosis');
            btn.textContent = 'ğŸ”„ è¯Šæ–­ä¸­...';
            btn.disabled = true;

            try {
                // æ˜¾ç¤ºè¯Šæ–­åŒºåŸŸ
                document.getElementById('diagnosis-section').style.display = 'block';
                document.getElementById('solution-section').style.display = 'block';

                // åˆå§‹åŒ–çŠ¶æ€ç½‘æ ¼
                initStatusGrid();

                // å¼€å§‹å„é¡¹æ£€æµ‹
                await loadMapAPI();
                await testBasicServices();
                await testTransitService();
                
                generateSolutions();

            } catch (error) {
                console.error('è¯Šæ–­è¿‡ç¨‹å‡ºé”™:', error);
                addResult('error', 'è¯Šæ–­è¿‡ç¨‹å‡ºé”™: ' + error.message);
            } finally {
                btn.textContent = 'å¼€å§‹è¯Šæ–­';
                btn.disabled = false;
            }
        }

        function initStatusGrid() {
            const grid = document.getElementById('status-grid');
            grid.innerHTML = `
                <div class="status-item" id="status-api">
                    <div class="status-icon">â³</div>
                    <div>APIåŠ è½½</div>
                </div>
                <div class="status-item" id="status-geocoding">
                    <div class="status-icon">â³</div>
                    <div>åœ°ç†ç¼–ç </div>
                </div>
                <div class="status-item" id="status-driving">
                    <div class="status-icon">â³</div>
                    <div>é©¾è½¦è·¯çº¿</div>
                </div>
                <div class="status-item" id="status-transit">
                    <div class="status-icon">â³</div>
                    <div>å…¬äº¤è·¯çº¿</div>
                </div>
            `;
        }

        function updateStatus(id, success, message = '') {
            const item = document.getElementById(id);
            if (success) {
                item.className = 'status-item success';
                item.querySelector('.status-icon').textContent = 'âœ…';
            } else {
                item.className = 'status-item error';
                item.querySelector('.status-icon').textContent = 'âŒ';
            }
            if (message) {
                item.querySelector('div:last-child').textContent = message;
            }
        }

        async function loadMapAPI() {
            return new Promise((resolve, reject) => {
                // ç§»é™¤æ—§è„šæœ¬
                const oldScript = document.querySelector('script[src*="webapi.amap.com"]');
                if (oldScript) {
                    oldScript.remove();
                }

                if (window.AMap) {
                    delete window.AMap;
                }

                const script = document.createElement('script');
                script.src = `https://webapi.amap.com/maps?v=1.4.15&key=${apiKey}`;

                script.onload = () => {
                    if (window.AMap) {
                        AMap = window.AMap;
                        updateStatus('status-api', true, 'APIåŠ è½½æˆåŠŸ');
                        addResult('success', 'APIè„šæœ¬åŠ è½½æˆåŠŸ');
                        resolve();
                    } else {
                        updateStatus('status-api', false, 'AMapå¯¹è±¡æœªæ‰¾åˆ°');
                        addResult('error', 'AMapå¯¹è±¡æœªæ‰¾åˆ°');
                        reject(new Error('AMapå¯¹è±¡æœªæ‰¾åˆ°'));
                    }
                };

                script.onerror = () => {
                    updateStatus('status-api', false, 'APIåŠ è½½å¤±è´¥');
                    addResult('error', 'APIè„šæœ¬åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIå¯†é’¥');
                    reject(new Error('APIè„šæœ¬åŠ è½½å¤±è´¥'));
                };

                document.head.appendChild(script);
            });
        }

        async function testBasicServices() {
            // æµ‹è¯•åœ°ç†ç¼–ç æœåŠ¡
            try {
                await testGeocoding();
                updateStatus('status-geocoding', true, 'åœ°ç†ç¼–ç æ­£å¸¸');
            } catch (error) {
                updateStatus('status-geocoding', false, 'åœ°ç†ç¼–ç å¤±è´¥');
                addResult('error', 'åœ°ç†ç¼–ç æœåŠ¡æµ‹è¯•å¤±è´¥: ' + error.message);
            }

            // æµ‹è¯•é©¾è½¦è·¯çº¿æœåŠ¡
            try {
                await testDriving();
                updateStatus('status-driving', true, 'é©¾è½¦è·¯çº¿æ­£å¸¸');
            } catch (error) {
                updateStatus('status-driving', false, 'é©¾è½¦è·¯çº¿å¤±è´¥');
                addResult('error', 'é©¾è½¦è·¯çº¿æœåŠ¡æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        function testGeocoding() {
            return new Promise((resolve, reject) => {
                AMap.plugin('AMap.Geocoder', function() {
                    const geocoder = new AMap.Geocoder({
                        city: 'åŒ—äº¬',
                        extensions: 'all'
                    });

                    geocoder.getLocation('å¤©å®‰é—¨', function(status, result) {
                        if (status === 'complete' && result.geocodes && result.geocodes.length > 0) {
                            addResult('success', 'åœ°ç†ç¼–ç æœåŠ¡æ­£å¸¸å·¥ä½œ');
                            resolve();
                        } else {
                            addResult('error', `åœ°ç†ç¼–ç å¤±è´¥: ${result.info || status}`);
                            reject(new Error(result.info || status));
                        }
                    });
                });
            });
        }

        function testDriving() {
            return new Promise((resolve, reject) => {
                AMap.plugin('AMap.Driving', function() {
                    const driving = new AMap.Driving({
                        map: null,
                        panel: null
                    });

                    driving.search([116.379028, 39.865042], [116.427281, 39.903719], function(status, result) {
                        if (status === 'complete' && result.routes && result.routes.length > 0) {
                            addResult('success', 'é©¾è½¦è·¯çº¿æœåŠ¡æ­£å¸¸å·¥ä½œ');
                            resolve();
                        } else {
                            addResult('error', `é©¾è½¦è·¯çº¿å¤±è´¥: ${result.info || status}`);
                            reject(new Error(result.info || status));
                        }
                    });
                });
            });
        }

        async function testTransitService() {
            // æµ‹è¯•ä¸åŒçš„å…¬äº¤è·¯çº¿é…ç½®
            const testConfigs = [
                {
                    name: 'åŸºç¡€é…ç½®',
                    config: {
                        city: 'åŒ—äº¬',
                        policy: AMap.TransferPolicy.LEAST_TIME
                    }
                },
                {
                    name: 'å…¨å›½é…ç½®',
                    config: {
                        city: 'å…¨å›½',
                        policy: AMap.TransferPolicy.LEAST_TIME
                    }
                },
                {
                    name: 'è·¨åŸå¸‚é…ç½®',
                    config: {
                        city: 'å…¨å›½',
                        cityd: 'å…¨å›½',
                        policy: AMap.TransferPolicy.LEAST_TIME
                    }
                }
            ];

            for (const testConfig of testConfigs) {
                try {
                    await testSingleTransitConfig(testConfig);
                } catch (error) {
                    console.error(`${testConfig.name}æµ‹è¯•å¤±è´¥:`, error);
                }
            }
        }

        function testSingleTransitConfig(testConfig) {
            return new Promise((resolve, reject) => {
                AMap.plugin('AMap.Transfer', function() {
                    const transfer = new AMap.Transfer({
                        map: null,
                        panel: null,
                        ...testConfig.config
                    });

                    transfer.search([
                        { keyword: 'åŒ—äº¬ç«™' },
                        { keyword: 'å¤©å®‰é—¨' }
                    ], function(status, result) {
                        console.log(`${testConfig.name} æµ‹è¯•ç»“æœ:`, status, result);
                        
                        if (status === 'complete' && result.plans && result.plans.length > 0) {
                            addResult('success', `${testConfig.name}: å…¬äº¤è·¯çº¿æŸ¥è¯¢æˆåŠŸ`);
                            updateStatus('status-transit', true, 'å…¬äº¤è·¯çº¿æ­£å¸¸');
                            resolve();
                        } else {
                            const errorInfo = result ? result.info : status;
                            addResult('error', `${testConfig.name}: ${errorInfo}`);
                            
                            if (errorInfo === 'INVALID_USER_SCODE') {
                                addResult('warning', 'æ£€æµ‹åˆ° INVALID_USER_SCODE é”™è¯¯ï¼Œè¿™é€šå¸¸è¡¨ç¤ºAPIå¯†é’¥æ²¡æœ‰å¼€é€šå…¬äº¤è·¯å¾„è§„åˆ’æœåŠ¡');
                                updateStatus('status-transit', false, 'æƒé™ä¸è¶³');
                            } else {
                                updateStatus('status-transit', false, errorInfo);
                            }
                            
                            reject(new Error(errorInfo));
                        }
                    });
                });
            });
        }

        function addResult(type, message) {
            const resultsDiv = document.getElementById('detailed-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `
                <strong>${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'âš ï¸'}</strong>
                ${message}
            `;
            resultsDiv.appendChild(resultDiv);
        }

        function generateSolutions() {
            const solutionContent = document.getElementById('solution-content');
            
            solutionContent.innerHTML = `
                <div class="fix-steps">
                    <h4>ğŸ”§ INVALID_USER_SCODE é”™è¯¯è§£å†³æ–¹æ¡ˆ</h4>
                    <ol>
                        <li><strong>ç™»å½•é«˜å¾·å¼€æ”¾å¹³å°æ§åˆ¶å°</strong>
                            <br>è®¿é—®: <a href="https://console.amap.com/" target="_blank">https://console.amap.com/</a>
                        </li>
                        <li><strong>æ£€æŸ¥åº”ç”¨é…ç½®</strong>
                            <br>è¿›å…¥"åº”ç”¨ç®¡ç†" â†’ æ‰¾åˆ°æ‚¨çš„åº”ç”¨ â†’ ç‚¹å‡»"æŸ¥çœ‹"
                        </li>
                        <li><strong>ç¡®è®¤æœåŠ¡æƒé™</strong>
                            <br>åœ¨åº”ç”¨è¯¦æƒ…é¡µé¢ï¼Œç¡®ä¿ä»¥ä¸‹æœåŠ¡å·²å¼€é€šï¼š
                            <div class="code">
âœ… WebæœåŠ¡API<br>
âœ… è·¯å¾„è§„åˆ’<br>
âœ… å…¬äº¤è·¯å¾„è§„åˆ’<br>
âœ… åœ°ç†ç¼–ç 
                            </div>
                        </li>
                        <li><strong>æ£€æŸ¥é…é¢é™åˆ¶</strong>
                            <br>ç¡®è®¤æ‚¨çš„APIè°ƒç”¨æ¬¡æ•°æ²¡æœ‰è¶…å‡ºé™åˆ¶
                        </li>
                        <li><strong>éªŒè¯APIå¯†é’¥</strong>
                            <br>ç¡®ä¿ä½¿ç”¨çš„æ˜¯æ­£ç¡®çš„APIå¯†é’¥ï¼Œä¸”æ²¡æœ‰è¿‡æœŸ
                        </li>
                        <li><strong>è”ç³»æŠ€æœ¯æ”¯æŒ</strong>
                            <br>å¦‚æœä»¥ä¸Šæ­¥éª¤éƒ½æ­£ç¡®ï¼Œè¯·è”ç³»é«˜å¾·æŠ€æœ¯æ”¯æŒ
                        </li>
                    </ol>
                </div>

                <div class="fix-steps">
                    <h4>ğŸ¯ æ›¿ä»£è§£å†³æ–¹æ¡ˆ</h4>
                    <ol>
                        <li><strong>ä½¿ç”¨é©¾è½¦+æ­¥è¡Œç»„åˆ</strong>
                            <br>å¦‚æœå…¬äº¤æœåŠ¡ä¸å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨é©¾è½¦è·¯çº¿ä½œä¸ºå‚è€ƒï¼Œç»“åˆæ­¥è¡Œè·¯çº¿
                        </li>
                        <li><strong>ç”³è¯·æ–°çš„APIå¯†é’¥</strong>
                            <br>é‡æ–°ç”³è¯·ä¸€ä¸ªåŒ…å«å®Œæ•´æœåŠ¡æƒé™çš„APIå¯†é’¥
                        </li>
                        <li><strong>ä½¿ç”¨å…¶ä»–åœ°å›¾æœåŠ¡</strong>
                            <br>è€ƒè™‘é›†æˆç™¾åº¦åœ°å›¾æˆ–è…¾è®¯åœ°å›¾çš„å…¬äº¤æœåŠ¡ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                        </li>
                    </ol>
                </div>

                <div class="fix-steps">
                    <h4>ğŸ“ è·å–å¸®åŠ©</h4>
                    <p>å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œæ‚¨å¯ä»¥ï¼š</p>
                    <ul>
                        <li>è®¿é—®é«˜å¾·å¼€æ”¾å¹³å°æ–‡æ¡£: <a href="https://lbs.amap.com/api/webservice/guide/api/direction" target="_blank">å…¬äº¤è·¯å¾„è§„åˆ’APIæ–‡æ¡£</a></li>
                        <li>æŸ¥çœ‹é«˜å¾·å¼€å‘è€…ç¤¾åŒº: <a href="https://developer.amap.com/" target="_blank">å¼€å‘è€…ç¤¾åŒº</a></li>
                        <li>è”ç³»é«˜å¾·æŠ€æœ¯æ”¯æŒè·å–ä¸“ä¸šå¸®åŠ©</li>
                    </ul>
                </div>
            `;
        }

        function clearResults() {
            document.getElementById('diagnosis-section').style.display = 'none';
            document.getElementById('solution-section').style.display = 'none';
            document.getElementById('detailed-results').innerHTML = '';
        }
    </script>
</body>
</html>
