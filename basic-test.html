<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºç¡€APIæµ‹è¯•</title>
    <script>
        window._AMapSecurityConfig = {
            securityJsCode: "db2b6cf5ae4f82ee233b1abe16aa459a",
        }
    </script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .warning { border-left-color: #ffc107; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 300px; }
        #map { width: 100%; height: 300px; border: 1px solid #ddd; margin: 10px 0; }
        .info { background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ é«˜å¾·åœ°å›¾APIåŸºç¡€æµ‹è¯•</h1>
        
        <div class="info">
            <h3>âš ï¸ å¦‚æœé‡åˆ° INVALID_USER_SCODE é”™è¯¯</h3>
            <p>è¯·æ£€æŸ¥ä»¥ä¸‹è®¾ç½®ï¼š</p>
            <ol>
                <li>ç™»å½• <a href="https://console.amap.com/" target="_blank">é«˜å¾·å¼€æ”¾å¹³å°æ§åˆ¶å°</a></li>
                <li>ç¡®ä¿åº”ç”¨ç±»å‹ä¸º "Webç«¯(JS API)"</li>
                <li>åœ¨ç™½åå•ä¸­æ·»åŠ  "localhost:8000" æˆ–è®¾ç½®ä¸º "*"</li>
                <li>ç¡®ä¿å¼€é€šäº†åœ°å›¾æ˜¾ç¤ºã€åœ°ç†ç¼–ç ç­‰æœåŠ¡</li>
            </ol>
        </div>

        <div>
            <h3>1. æµ‹è¯•APIå¯†é’¥</h3>
            <input type="password" id="apiKey" placeholder="è¾“å…¥APIå¯†é’¥">
            <button onclick="testAPI()">æµ‹è¯•å¯†é’¥</button>
            <div id="apiResult" class="result">è¯·è¾“å…¥APIå¯†é’¥</div>
        </div>

        <div>
            <h3>2. æµ‹è¯•åœ°å›¾æ˜¾ç¤º</h3>
            <button onclick="testMap()">åˆ›å»ºåœ°å›¾</button>
            <div id="map"></div>
            <div id="mapResult" class="result">è¯·å…ˆæµ‹è¯•APIå¯†é’¥</div>
        </div>

        <div>
            <h3>3. æµ‹è¯•æœåŠ¡æƒé™</h3>
            <button onclick="testServices()">æ£€æŸ¥æœåŠ¡æƒé™</button>
            <div id="serviceResult" class="result">è¯·å…ˆåˆ›å»ºåœ°å›¾</div>
        </div>
    </div>

    <script>
        let AMap;
        let map;

        function testAPI() {
            const key = document.getElementById('apiKey').value.trim();
            const result = document.getElementById('apiResult');
            
            if (!key) {
                result.innerHTML = 'âŒ è¯·è¾“å…¥APIå¯†é’¥';
                result.className = 'result error';
                return;
            }

            result.innerHTML = 'ğŸ”„ æ­£åœ¨æµ‹è¯•APIå¯†é’¥...';
            result.className = 'result';

            // ç§»é™¤æ—§è„šæœ¬
            const oldScript = document.querySelector('script[src*="webapi.amap.com"]');
            if (oldScript) oldScript.remove();

            const script = document.createElement('script');
            script.src = `https://webapi.amap.com/maps?v=1.4.15&key=${key}`;
            
            script.onload = () => {
                if (window.AMap) {
                    AMap = window.AMap;
                    result.innerHTML = `âœ… APIå¯†é’¥æœ‰æ•ˆï¼
å¯ä»¥è®¿é—®é«˜å¾·åœ°å›¾æœåŠ¡
å¯†é’¥: ${key.substring(0, 8)}...`;
                    result.className = 'result success';
                } else {
                    result.innerHTML = 'âŒ APIå¯¹è±¡æœªæ‰¾åˆ°ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜';
                    result.className = 'result error';
                }
            };
            
            script.onerror = () => {
                result.innerHTML = `âŒ æ— æ³•åŠ è½½API
å¯èƒ½åŸå› ï¼š
1. APIå¯†é’¥æ— æ•ˆ
2. ç½‘ç»œè¿æ¥é—®é¢˜
3. å¹¿å‘Šæ‹¦æˆªå™¨é˜»æ­¢äº†è¯·æ±‚`;
                result.className = 'result error';
            };
            
            document.head.appendChild(script);
        }

        function testMap() {
            const result = document.getElementById('mapResult');
            
            if (!AMap) {
                result.innerHTML = 'âŒ è¯·å…ˆæµ‹è¯•APIå¯†é’¥';
                result.className = 'result error';
                return;
            }

            result.innerHTML = 'ğŸ”„ æ­£åœ¨åˆ›å»ºåœ°å›¾...';
            result.className = 'result';

            try {
                map = new AMap.Map('map', {
                    zoom: 11,
                    center: [116.397428, 39.90923], // å¤©å®‰é—¨åæ ‡
                    mapStyle: 'amap://styles/normal'
                });

                // ç›‘å¬åœ°å›¾åŠ è½½å®Œæˆäº‹ä»¶
                map.on('complete', function() {
                    result.innerHTML = `âœ… åœ°å›¾åˆ›å»ºæˆåŠŸï¼
ä¸­å¿ƒç‚¹: å¤©å®‰é—¨ (116.397428, 39.90923)
ç¼©æ”¾çº§åˆ«: 11
åœ°å›¾æ ·å¼: æ ‡å‡†æ ·å¼`;
                    result.className = 'result success';
                });

                // ç›‘å¬åœ°å›¾åŠ è½½é”™è¯¯äº‹ä»¶
                map.on('error', function(error) {
                    result.innerHTML = `âŒ åœ°å›¾åŠ è½½å¤±è´¥: ${error.message}`;
                    result.className = 'result error';
                });

            } catch (error) {
                result.innerHTML = `âŒ åœ°å›¾åˆ›å»ºå¤±è´¥: ${error.message}
å¯èƒ½åŸå› ï¼š
1. APIå¯†é’¥æƒé™ä¸è¶³
2. æœåŠ¡æœªå¼€é€š
3. ç½‘ç»œè¿æ¥é—®é¢˜`;
                result.className = 'result error';
            }
        }

        function testServices() {
            const result = document.getElementById('serviceResult');
            
            if (!AMap || !map) {
                result.innerHTML = 'âŒ è¯·å…ˆåˆ›å»ºåœ°å›¾';
                result.className = 'result error';
                return;
            }

            result.innerHTML = 'ğŸ”„ æ­£åœ¨æ£€æŸ¥æœåŠ¡æƒé™...';
            result.className = 'result';

            let testResults = [];
            let completedTests = 0;
            const totalTests = 4;

            function checkTestCompletion() {
                completedTests++;
                if (completedTests === totalTests) {
                    const successCount = testResults.filter(r => r.success).length;
                    const resultClass = successCount === totalTests ? 'success' : 
                                       successCount > 0 ? 'warning' : 'error';
                    
                    result.innerHTML = `æœåŠ¡æƒé™æ£€æŸ¥å®Œæˆ (${successCount}/${totalTests}):

${testResults.map(r => r.message).join('\n')}

${successCount < totalTests ? `
âš ï¸ éƒ¨åˆ†æœåŠ¡ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ï¼š
1. APIå¯†é’¥æ˜¯å¦å¼€é€šäº†ç›¸åº”æœåŠ¡
2. ç™½åå•è®¾ç½®æ˜¯å¦æ­£ç¡®
3. æ˜¯å¦æœ‰å¹¿å‘Šæ‹¦æˆªå™¨å¹²æ‰°` : 'ğŸ‰ æ‰€æœ‰åŸºç¡€æœåŠ¡éƒ½å¯ç”¨ï¼'}`;
                    result.className = `result ${resultClass}`;
                }
            }

            // æµ‹è¯•1: åœ°å›¾æ§ä»¶
            try {
                map.addControl(new AMap.Scale());
                testResults.push({success: true, message: 'âœ… åœ°å›¾æ§ä»¶æœåŠ¡æ­£å¸¸'});
            } catch (error) {
                testResults.push({success: false, message: `âŒ åœ°å›¾æ§ä»¶æœåŠ¡å¤±è´¥: ${error.message}`});
            }
            checkTestCompletion();

            // æµ‹è¯•2: åŸå¸‚æœç´¢ï¼ˆIPå®šä½ï¼‰
            AMap.plugin('AMap.CitySearch', function() {
                const citySearch = new AMap.CitySearch();
                citySearch.getLocalCity(function(status, cityResult) {
                    if (status === 'complete' && cityResult.info === 'OK') {
                        testResults.push({success: true, message: `âœ… åŸå¸‚æœç´¢æœåŠ¡æ­£å¸¸ (å½“å‰åŸå¸‚: ${cityResult.city})`});
                    } else {
                        testResults.push({success: false, message: `âŒ åŸå¸‚æœç´¢æœåŠ¡å¤±è´¥: ${status}`});
                    }
                    checkTestCompletion();
                });
            });

            // æµ‹è¯•3: åœ°ç†ç¼–ç 
            AMap.plugin('AMap.Geocoder', function() {
                const geocoder = new AMap.Geocoder();
                geocoder.getLocation('åŒ—äº¬', function(status, geocodeResult) {
                    if (status === 'complete' && geocodeResult.geocodes && geocodeResult.geocodes.length > 0) {
                        testResults.push({success: true, message: 'âœ… åœ°ç†ç¼–ç æœåŠ¡æ­£å¸¸'});
                    } else {
                        testResults.push({success: false, message: `âŒ åœ°ç†ç¼–ç æœåŠ¡å¤±è´¥: ${status}`});
                    }
                    checkTestCompletion();
                });
            });

            // æµ‹è¯•4: å®šä½æœåŠ¡
            AMap.plugin('AMap.Geolocation', function() {
                const geolocation = new AMap.Geolocation({
                    enableHighAccuracy: false,
                    timeout: 5000
                });
                
                geolocation.getCurrentPosition(function(status, geoResult) {
                    if (status === 'complete') {
                        testResults.push({success: true, message: 'âœ… å®šä½æœåŠ¡æ­£å¸¸'});
                    } else {
                        testResults.push({success: false, message: `âŒ å®šä½æœåŠ¡å¤±è´¥: ${status} (è¿™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼Œå–å†³äºè®¾å¤‡å’Œæƒé™)`});
                    }
                    checkTestCompletion();
                });
            });
        }
    </script>
</body>
</html>
